<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard | Shree Ram Packers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f7fa;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    #chartContainer {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
  </style>
</head>
<body>
  <h2>ðŸ“Š Employee Work Performance</h2>
  <div id="chartContainer">
    <canvas id="performanceChart"></canvas>
  </div>

  <script src="firebase-config.js"></script>
  <script>
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (user) {
        db.collection("users").doc(user.uid).get().then(doc => {
          if (!doc.exists || doc.data().role !== "admin") {
            alert("âŒ Unauthorized: Only admins allowed.");
            window.location.href = "index.html";
          } else {
            loadPerformanceChart();
          }
        });
      } else {
        window.location.href = "index.html";
      }
    });

    async function loadPerformanceChart() {
      const tasksSnapshot = await db.collection("tasks").get();
      const performanceData = {};

      for (const doc of tasksSnapshot.docs) {
        const employeeName = doc.id;
        const dateCollections = await doc.ref.listCollections();

        let totalAssigned = 0;
        let totalCompleted = 0;

        for (const dateCol of dateCollections) {
          const summaryDoc = await dateCol.doc("summary").get();
          if (summaryDoc.exists) {
            const data = summaryDoc.data();
            totalAssigned += data.assigned || 0;
            totalCompleted += data.completed || 0;
          }
        }

        if (totalAssigned > 0) {
          performanceData[employeeName] = {
            assigned: totalAssigned,
            completed: totalCompleted
          };
        }
      }

      const labels = Object.keys(performanceData);
      const completedData = labels.map(name => performanceData[name].completed);
      const assignedData = labels.map(name => performanceData[name].assigned);

      const ctx = document.getElementById('performanceChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Completed',
              data: completedData,
              backgroundColor: 'rgba(40, 167, 69, 0.6)'
            },
            {
              label: 'Assigned',
              data: assignedData,
              backgroundColor: 'rgba(0, 123, 255, 0.6)'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
</body>
</html>
