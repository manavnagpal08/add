<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Dashboard | Shree Ram Packers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f7fa;
      margin: 0;
      padding: 30px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 600;
    }
    canvas, table {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 20px;
      max-width: 800px;
      margin: 30px auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>

  <h2>üèÜ Top 5 Employees by Word Count (Last 14 Days)</h2>
  <canvas id="barChart" height="150"></canvas>

  <h2>üîç Filter Work by Tag & Date</h2>
  <div style="text-align: center; margin: 20px 0;">
    <select id="tagSelect">
      <option value="">-- Select Tag --</option>
      <option value="Packing">Packing</option>
      <option value="Delivery">Delivery</option>
      <option value="QC">QC</option>
      <option value="Loading">Loading</option>
    </select>
    <input type="date" id="tagDate" />
    <button onclick="filterByTag()">View</button>
  </div>
  <div id="tagResults"></div>

  <h2>üóìÔ∏è Monthly Employee Report</h2>
  <div style="text-align: center; margin: 20px 0;">
    <input type="month" id="monthSelect">
    <button onclick="generateMonthlyReport()">Generate</button>
  </div>
  <div id="monthlyReport"></div>

  <h2>ü•á AI Employee Leaderboard</h2>
  <div style="text-align: center; margin: 20px 0;">
    <input type="month" id="leaderMonth">
    <button onclick="generateLeaderboard()">Show Leaderboard</button>
  </div>
  <div id="leaderboardTable"></div>

  <script src="firebase-config.js"></script>
  <script>
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const today = new Date();
    const pastDays = [...Array(14)].map((_, i) => {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      return d.toISOString().split('T')[0];
    });

    const employeeWordCounts = {};

    async function generateBarChart() {
      const usersSnap = await db.collection("tasks").get();
      const allPromises = [];

      usersSnap.forEach(userDoc => {
        const uid = userDoc.id;

        pastDays.forEach(date => {
          const summaryRef = db.collection("tasks").doc(uid).collection(date).doc("summary");
          allPromises.push(summaryRef.get().then(docSnap => {
            if (docSnap.exists) {
              const wordCount = docSnap.data().wordCount || 0;
              employeeWordCounts[uid] = (employeeWordCounts[uid] || 0) + wordCount;
            }
          }));
        });
      });

      await Promise.all(allPromises);

      const userData = [];
      const userInfoSnap = await db.collection("users").get();
      userInfoSnap.forEach(doc => {
        const uid = doc.id;
        const name = doc.data().name || uid;
        const count = employeeWordCounts[uid] || 0;
        if (count > 0) userData.push({ name, count });
      });

      const topEmployees = userData.sort((a, b) => b.count - a.count).slice(0, 5);

      new Chart(document.getElementById("barChart").getContext("2d"), {
        type: 'bar',
        data: {
          labels: topEmployees.map(e => e.name),
          datasets: [{
            label: 'Total Words Written',
            data: topEmployees.map(e => e.count),
            backgroundColor: '#007bff',
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    generateBarChart();

    function filterByTag() {
      const tag = document.getElementById('tagSelect').value;
      const date = document.getElementById('tagDate').value;
      const output = document.getElementById('tagResults');
      output.innerHTML = "";

      if (!tag || !date) {
        output.innerHTML = "<p>Please select both tag and date.</p>";
        return;
      }

      output.innerHTML = "<p>Loading...</p>";

      db.collection("tasks").get().then(snapshot => {
        const promises = [];
        snapshot.forEach(userDoc => {
          const uid = userDoc.id;
          const summaryRef = db.collection("tasks").doc(uid).collection(date).doc("summary");
          promises.push(
            Promise.all([summaryRef.get(), db.collection("users").doc(uid).get()])
              .then(([summaryDoc, userDoc]) => {
                if (summaryDoc.exists && summaryDoc.data().tags?.includes(tag)) {
                  const name = userDoc.exists ? userDoc.data().name : uid;
                  return `<div><strong>${name}</strong>: ${summaryDoc.data().work}</div>`;
                }
                return null;
              })
          );
        });

        Promise.all(promises).then(results => {
          const filtered = results.filter(Boolean);
          output.innerHTML = filtered.length ? filtered.join("") : "<p>No results found.</p>";
        });
      });
    }

    function generateMonthlyReport() {
      const selectedMonth = document.getElementById("monthSelect").value;
      const container = document.getElementById("monthlyReport");
      container.innerHTML = "";
      if (!selectedMonth) return container.innerHTML = "<p>Select month.</p>";

      const [year, month] = selectedMonth.split("-").map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();
      const dates = [...Array(daysInMonth)].map((_, i) => `${year}-${String(month).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`);

      const reportData = {};

      db.collection("tasks").get().then(snapshot => {
        const promises = [];

        snapshot.forEach(userDoc => {
          const uid = userDoc.id;
          reportData[uid] = { totalWords: 0, daysWorked: 0 };

          dates.forEach(date => {
            const ref = db.collection("tasks").doc(uid).collection(date).doc("summary");
            promises.push(ref.get().then(doc => {
              if (doc.exists) {
                reportData[uid].totalWords += doc.data().wordCount || 0;
                reportData[uid].daysWorked++;
              }
            }));
          });
        });

        Promise.all(promises).then(() => {
          db.collection("users").get().then(userSnapshot => {
            let table = `<table><tr><th>Employee</th><th>Days Worked</th><th>Word Count</th></tr>`;
            userSnapshot.forEach(doc => {
              const uid = doc.id;
              const name = doc.data().name || uid;
              const stats = reportData[uid];
              if (stats.daysWorked > 0) {
                table += `<tr><td>${name}</td><td>${stats.daysWorked}</td><td>${stats.totalWords}</td></tr>`;
              }
            });
            table += `</table>`;
            container.innerHTML = table;
          });
        });
      });
    }

    function generateLeaderboard() {
      const selectedMonth = document.getElementById("leaderMonth").value;
      const output = document.getElementById("leaderboardTable");
      output.innerHTML = "";
      if (!selectedMonth) return output.innerHTML = "<p>Select month.</p>";

      const [year, month] = selectedMonth.split("-").map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();
      const dates = [...Array(daysInMonth)].map((_, i) => `${year}-${String(month).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`);

      const scoreData = {};

      db.collection("tasks").get().then(snapshot => {
        const promises = [];

        snapshot.forEach(userDoc => {
          const uid = userDoc.id;
          scoreData[uid] = { totalWords: 0, daysWorked: 0 };

          dates.forEach(date => {
            const ref = db.collection("tasks").doc(uid).collection(date).doc("summary");
            promises.push(ref.get().then(doc => {
              if (doc.exists) {
                scoreData[uid].totalWords += doc.data().wordCount || 0;
                scoreData[uid].daysWorked++;
              }
            }));
          });
        });

        Promise.all(promises).then(() => {
          db.collection("users").get().then(userSnap => {
            const leaderboard = [];

            userSnap.forEach(doc => {
              const uid = doc.id;
              const name = doc.data().name || uid;
              const d = scoreData[uid];
              if (d.daysWorked > 0) {
                const score = d.totalWords * 2 + d.daysWorked * 10;
                leaderboard.push({ name, ...d, score });
              }
            });

            leaderboard.sort((a, b) => b.score - a.score);

            let html = `<table><tr><th>Rank</th><th>Employee</th><th>Days</th><th>Words</th><th>AI Score</th></tr>`;
            leaderboard.forEach((emp, i) => {
              html += `<tr><td>${i+1}</td><td>${emp.name}</td><td>${emp.daysWorked}</td><td>${emp.totalWords}</td><td>${emp.score}</td></tr>`;
            });
            html += `</table>`;
            output.innerHTML = html;
          });
        });
      });
    }
  </script>
</body>
</html>
